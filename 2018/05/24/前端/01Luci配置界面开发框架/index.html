<!DOCTYPE HTML>
<html lang>
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="Flipped205">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://Flipped205.github.io/BlogCode">
    <!--SEO-->





<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->


<title>Luci配置界面开发框架 | Flipped205</title>


    <link rel="alternate" href="/atom.xml" title="Flipped205" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=2020-02-18[06]">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=2020-02-18[06]">
<link rel="stylesheet" href="/css/style.css?rev=2020-02-18[06]">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>






    
</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <div class="box_bk"></div>
<div class="box_center">
    <div class="box_i"><img src=""></div>
    <div class="box_close"><img src="/img/close.png"></div>
</div>
<button class="btn" style="display:none"></button>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>主页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/笔记/"><i class="fa "></i>笔记</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/杂读/"><i class="fa "></i>杂读</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/工具/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/前端/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/心记/"><i class="fa "></i>心记</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Luci配置界面开发框架">
            
	            Luci配置界面开发框架
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/前端">
            前端
        </a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
                    <a href="/tags/Luci" title='Luci'>
                        Luci
                    </a>
                
            
        </span>
    </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-calendar-o"></i>
            <span class="date-meta">发表于:&nbsp;2018/05/24</span>
        </span>
        <span class="fa-wrap">
            
        </span>
    
</div>

            

           
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>635</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>Luci配置界面开发框架</p>
<p>MVC:</p>
<blockquote>
<p>Model(/usr/lib/lua/luci/model/cbi)<br>Controller(/usr/lib/lua/luci/controller)<br>View()</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/uhttpd -f -h /www -r LEDE -x /cgi-bin -u /ubus -t 60 -T 30 -k 20 -A 1 -n 3 -N 100 -R -p 0.0.0.0:80 -p [::]:80</span><br></pre></td></tr></table></figure>

<p>uhttpd是基于ubox ubus json-c的，如果加上ssl,还需要openssl库</p>
<h2 id="openwrt-libubox："><a href="#openwrt-libubox：" class="headerlink" title="openwrt libubox："></a>openwrt libubox：</h2><p>libubox是openwrt新版本中的一个基础库，在openwrt中有很多应用程序是基于libubox开发的。（如uhttpd, linubus）。</p>
<h3 id="libubox"><a href="#libubox" class="headerlink" title="libubox:"></a>libubox:</h3><blockquote>
<ul>
<li>提供一套基于事件驱动的机制  </li>
<li>提供多种开发支持接口。（如链表、kv聊表、平衡查找二叉树、md5、json）</li>
</ul>
</blockquote>
<p>使用libubox开发的好处有如下几点：</p>
<blockquote>
<ul>
<li>1、可以是程序基于事件驱动，从而可实现在单进程中处理多个任务</li>
<li>2、基于libubox提供的开发API可以加快开发进度的同时提高程序的稳定性</li>
<li>3、能更好的将程序融入openwrt的开发架构中，因为新的openwrt得很多应用和库都基于libubox开发的</li>
</ul>
</blockquote>
<h2 id="openwrt-ubus"><a href="#openwrt-ubus" class="headerlink" title="openwrt ubus"></a>openwrt ubus</h2><p>ubus是最新openwrt引入的一个消息总线，主要作用是实现不同应用程序之间的信息交互。<br>ubus启动后会在后台运行ubusd进程，该进程监听一个unix套接字用于与其他应用程序通信。其他应用程序可基于libubox提供的接口（或自己实现）与其通信。</p>
<p>使用ubus的方式主要有：  </p>
<blockquote>
<ul>
<li>1、向其注册消息或控制接口。  </li>
<li>2、向其调用其他应用程序的消息或控制接口。  </li>
<li>3、向其注册关心事件</li>
</ul>
</blockquote>
<p><a href="https://wiki.openwrt.org/zh-cn/doc/uci" target="_blank" rel="noopener">ubus (OpenWrt micro bus 架构)</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/uhttpd -f -h /www -r LEDE -x /cgi-bin -u /ubus -t 60 -T 30 -k 20 -A 1 -n 3 -N 100 -R -p 0.0.0.0:80 -p [::]:80</span><br></pre></td></tr></table></figure>

<h2 id="1、Luci配置界面开发框架-Controller"><a href="#1、Luci配置界面开发框架-Controller" class="headerlink" title="1、Luci配置界面开发框架(Controller)"></a>1、Luci配置界面开发框架(Controller)</h2><p>Controller定义模块的入口</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module(<span class="string">"luci.controller.控制器名"</span>,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line">        entry(路径,调用目标,_(<span class="string">"显示名称"</span>),显示顺序)</span><br><span class="line">        <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>第一行说明了程序和模块的名称，eg:controller/目录下创建parentctrl.lua,那么久应该写成”luci.controller.parentctrl”。如果程序较多，可以分为好几个模块，那么可以在controller下再创建一个子目录，eg:controller/app/,那么就可以下城”luci.controller.app.parentctrl”。  </p>
</blockquote>
<blockquote>
<p>entry表示一个模块的入口，官方给出entry的定义如下：<br><code>entry(path, target, title=nil, order=nil)</code><br>path为访问路径，路径按字符串数组给定的，eg:{“admin”,”more_set”,”parentctrl”},那么在浏览器里访问“<a href="http://192.168.2.1/cgi-bin/luci/admin/more_set/parentctrl”" target="_blank" rel="noopener">http://192.168.2.1/cgi-bin/luci/admin/more_set/parentctrl”</a> 来访问该脚本。  </p>
<ul>
<li>第一种直接调用指定函数，比如直接重启路由器，eg:写成“<code>call(&quot;function_name&quot;)</code>”，然后又在Lua文件中编写名为function_name的函数就可以调用了。</li>
<li>第二种可以访问指定页面，eg:“<code>template(&quot;pc/parentctrl&quot;)</code>”就可以调用/usr/lib/lua/luci/view/pc/parentctrl.html。</li>
<li>配置界面，第三种方法无非最方便的，eg:“<code>cbi(&quot;app/parentctrl&quot;)</code>”就可以调用/usr/lib/lua/luci/model/cbi/app/parentctrl.lua。</li>
</ul>
</blockquote>
<p>eg:创建/usr/lib/lua/luci/controller/njitclient.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module(<span class="string">"luci.controller.njitclient"</span>,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line">    entry(&#123;<span class="string">"admin"</span>, <span class="string">"network"</span>, <span class="string">"njitclient"</span>&#125;, cbi(<span class="string">"njitclient"</span>) , _(<span class="string">"NJITClient"</span>), <span class="number">100</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="2、用Lua和UCI接口开发LuCI配置模块-Model"><a href="#2、用Lua和UCI接口开发LuCI配置模块-Model" class="headerlink" title="2、用Lua和UCI接口开发LuCI配置模块(Model)"></a>2、用Lua和UCI接口开发LuCI配置模块(Model)</h2><p>功能描述：希望将用户名、密码等信息存储在路由器文件中，同时路由器开机时能根据设定的配置自动运行njitclient,同时希望动态的禁止和启用njitclient等等。所有最好的方式使用<code>CBI Module</code>,创建model文件，/usr/lib/lua/luci/model/cbi/njitclient.lua</p>
<p>开发LuCI的配置模块的有很多方式，比较基本的可以用SimpleForm，就跟开发普通的Web应用类似，当然最方便的还是使用UCI（Unified Configuration Interface,统一配置接口）的方式，因为使用UCI接口可以使得在LuCI中无需考虑配置文件如何存储和读取(这种方式也会自动创建“保存&amp;应用”、“保存”以及“复位”三个按钮)。同时在Bash文件中也可以非常方便的存储和读取。</p>
<h2 id="对于UCI方式"><a href="#对于UCI方式" class="headerlink" title="对于UCI方式"></a>对于UCI方式</h2><p>(1)、创建配置文件，存储于/etc/config。eg:<code>/etc/config/njitclient</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config login</span><br><span class="line">    option username <span class="string">''</span></span><br><span class="line">    option password <span class="string">''</span></span><br><span class="line">    option ifname <span class="string">'eth0'</span></span><br><span class="line">    option domain <span class="string">''</span></span><br></pre></td></tr></table></figure>

<p>配置文件的编写参见<a href="https://wiki.openwrt.org/zh-cn/doc/uci" target="_blank" rel="noopener">UCI系统文档</a></p>
<p>(2)、然后在CBI Module的lua文件中首先需要映射与存储文件的关系<br>eg:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m = Map(njitclient,<span class="string">"NJIT Client"</span>, Configure NJIT <span class="number">802.11</span>x client.<span class="string">")</span></span><br></pre></td></tr></table></figure>

<p>m = Map(“配置文件名”,”配置页面标题”,”配置页面说明”)</p>
<blockquote>
<p>第一个参数即为配置文件存储的文件名，不包含路径。<br>第二个参数和第三个参数用于页面显示。</p>
</blockquote>
<div align="center">
<img src="/img/web_01/01.png">
</div>

<p>(3)、创建与配置文件中对应的<code>Section</code>，Section分两种，<code>NamedSection</code>和<code>TypedSection</code>前者根据配置文件中的Section名，后者根据配置文件中的Section类型。这里使用后者。代码如下，同时设置不允许增加或删除Section(“.addremove=false”),以及不显示Section名称(“.anonymous=true”)。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = m:section(TypedSection, <span class="string">"login"</span>, <span class="string">""</span>)</span><br><span class="line">s.addremove = <span class="literal">false</span></span><br><span class="line">s.anonymous = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>(4)、接下来创建Section中不同内容的交互（创建Option），常见的比如有Value(文本框)、ListValue(下拉框)、Flag(选择框)等等。详见官方参考文档<a href="http://luci.subsignal.org/trac/wiki/Documentation/CBI" target="_blank" rel="noopener">CBI</a></p>
<p>创建Option的过程非常简单，创建后无需考虑读写配置问题，系统都会自动处理，但是根据上述的要求，我们在应用配置后希望启用、晋中或重启njitclient，所有我们需要在页面最后判断用户是否点击“应用”按钮，以及点击后的动作。  </p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> apply = luci.http.formvlaue(<span class="string">"cbi.apply"</span>)</span><br><span class="line"><span class="keyword">if</span> apply <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--[[</span></span><br><span class="line"><span class="comment">        需要处理的代码</span></span><br><span class="line"><span class="comment">    ]]</span><span class="comment">--</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>model文件完整代码njitclient.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"luci.sys"</span>)</span><br><span class="line"></span><br><span class="line">m = Map(<span class="string">"njitclient"</span>, translate(<span class="string">"NJIT Client"</span>), translate(<span class="string">"Configure NJIT 802.11x Client"</span>))</span><br><span class="line"></span><br><span class="line">s = m:section(TypedSection, <span class="string">"login"</span>, <span class="string">""</span>)</span><br><span class="line">s.addremove = <span class="literal">false</span></span><br><span class="line">s.anonymous = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">enable = s:option(Flag,<span class="string">"enable"</span>, translate(<span class="string">"Enable"</span>))</span><br><span class="line">name = s:option(Value, <span class="string">"username"</span>, translate(<span class="string">"Username"</span>))</span><br><span class="line">pass = s:option(Value, <span class="string">"password"</span>, translate(<span class="string">"Password"</span>))</span><br><span class="line">pass.password = <span class="literal">true</span></span><br><span class="line">domain = s:option(Value, <span class="string">"domain"</span>, translate(<span class="string">"Domain"</span>))</span><br><span class="line"></span><br><span class="line">ifname = s:option(ListValue, <span class="string">"ifname"</span>, translate(<span class="string">"Interface"</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(luci.sys.net.devices()) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> v ~= <span class="string">"lo"</span> <span class="keyword">then</span></span><br><span class="line">        ifname:value(v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> apply = luci.http.formvalue(<span class="string">"cbi.apply"</span>)</span><br><span class="line"><span class="keyword">if</span> apply the</span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">popen</span>(<span class="string">"/etc/init.d/njitclient restart"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> m</span><br></pre></td></tr></table></figure>

<p>其中Luci全部库类的函数定义和使用说明，可以参考<a href="http://luci.subsignal.org/api/luci/index.html" target="_blank" rel="noopener">Luci API</a></p>
<h2 id="3、Bash文件中调用UCI接口"><a href="#3、Bash文件中调用UCI接口" class="headerlink" title="3、Bash文件中调用UCI接口"></a>3、Bash文件中调用UCI接口</h2><p>接下来编写njitclient脚本，使得程序最终运行起来。关于UCI接口的脚本文档中官方参考资料<a href="https://wiki.openwrt.org/doc/devel/config-scripting" target="_blank" rel="noopener">Configuration in scripts</a></p>
<p>(1)、使用UCI调用脚本，第一步需要读取配置文件，命令为“<code>config_load 配置文件名</code>”。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config_load njitclient</span><br></pre></td></tr></table></figure>

<p>(2)、接下来遍历配置中的Section，可以使用“<code>config_foreach 遍历函数名为Section类型</code>”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config_foreach run_njit login</span><br></pre></td></tr></table></figure>

<p>(3)、编写名为<code>run_njit</code>函数，在这个函数中，可以使用“<code>config_get 变量名 Section名 Section参数名</code>”获取变量的值，或者使用“<code>config_get_bool变量名 Section名 Section参数名</code>”获取布尔的值。</p>
<p>njitclient完整脚本如下</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh /etc/rc.common</span><br><span class="line">START=<span class="number">50</span></span><br><span class="line">run_njit()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">local</span> enable</span><br><span class="line">    config_get bool enable $<span class="number">1</span> enable</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [$enable]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> username</span><br><span class="line">        <span class="keyword">local</span> password</span><br><span class="line">        <span class="keyword">local</span> domain</span><br><span class="line">        <span class="keyword">local</span> ifname</span><br><span class="line"></span><br><span class="line">        config_get username $<span class="number">1</span> username</span><br><span class="line">        config_get password $<span class="number">1</span> password</span><br><span class="line">        config_get domain $<span class="number">1</span> domain</span><br><span class="line">        config_get ifname $<span class="number">1</span> ifname</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"$domain"</span> !=<span class="string">""</span> ]; <span class="keyword">then</span></span><br><span class="line">            njit-client $username@$domain $password $ifname &amp;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            njit-client $username $password $ifname &amp;</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        echo <span class="string">"NJIT Client hase started."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start()</span><br><span class="line">&#123;</span><br><span class="line">    config_load njitclient</span><br><span class="line">    config_foreach run_njit login</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">stop()</span><br><span class="line">&#123;</span><br><span class="line">    killall njit-client</span><br><span class="line">    killall udhcpc</span><br><span class="line"></span><br><span class="line">    echo <span class="string">"NJIT Client has stoped."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>openwrt uhttpd交互流程<br>docroot 为/www   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@LEDE:/www<span class="meta"># ls -l</span></span><br><span class="line">drwxrwxr-x    <span class="number">2</span> root     root            <span class="number">27</span> Aug <span class="number">12</span> <span class="number">00</span>:<span class="number">12</span> cgi-bin</span><br><span class="line">-rw-rw-r--    <span class="number">1</span> root     root           <span class="number">495</span> Aug <span class="number">12</span> <span class="number">00</span>:<span class="number">12</span> index.html</span><br><span class="line">drwxrwxr-x    <span class="number">4</span> root     root            <span class="number">49</span> Aug <span class="number">12</span> <span class="number">00</span>:<span class="number">12</span> luci-<span class="keyword">static</span></span><br></pre></td></tr></table></figure>

<p>(1)、默认index.html,该文件内容如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Cache-Control"</span> <span class="attr">content</span>=<span class="string">"no-cache"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"0; URL=/cgi-bin/luci"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"background-color: white"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">"color: black; font-family: arial, helvetica, sans-serif;"</span> <span class="attr">href</span>=<span class="string">"/cgi-bin/luci"</span>&gt;</span>LuCI - Lua Configuration Interface<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>默认跳转/cgi-bin/luci，注：luci该文件相对于docroot而言的路径，即相对于/www。<br>(2)、则实际路径为/www/cgi-bin/luci。该文件内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/lua  <span class="comment">--执行命令的路径</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">"luci.cacheloader"</span>   <span class="comment">--导入cacheloader包</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">"luci.sgi.cgi"</span>       <span class="comment">--导入sgi.sgi包</span></span><br><span class="line">luci.dispatcher.indexcache = <span class="string">"/tmp/luci-indexcache"</span> <span class="comment">--cache缓存路径地址</span></span><br><span class="line">luci.sgi.cgi.run()  <span class="comment">--执行run方法，此方法于/usr/lib/lua/luci/sgi/cgi.lua</span></span><br></pre></td></tr></table></figure>

<p>(3)、cgi.lua文件内容 /usr/lib/lua/luci/sgi/cgi.lua<br><a href="#cgi">cgi.lua文件完整内容</a></p>
<p>代码解释：  </p>
<blockquote>
<p>首先执行的是run()函数:</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> r = luci.http.Request(...)   <span class="comment">--把Web请求放于r中，（包括环境变量，web请求，出错处理接口）</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>create出另一个执行体<code>httpdispatch</code>,每次httpdispatch执行yield返回一些数据时，run()函数读取这些数据，做相应处理，然后再次执行resume(httpdispatch),…如此直到httpdispatch执行完毕。</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> x = coroutine.<span class="built_in">create</span>(luci.dispatcher.httpdispatch)  <span class="comment">--创建一个协同程序</span></span><br><span class="line"><span class="keyword">local</span> res, id, data1, data2 = coroutine.<span class="built_in">resume</span>(x, r) <span class="comment">--运行创建的协同进程，即运行httpdispatch，参数为上面的local r变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> id == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">"Status: "</span> .. <span class="built_in">tostring</span>(data1) .. <span class="string">" "</span> .. data2 .. <span class="string">"\r\n"</span>)</span><br><span class="line"><span class="keyword">elseif</span> id == <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">    hcache = hcache .. data1 .. <span class="string">": "</span> .. data2 .. <span class="string">"\r\n"</span>  <span class="comment">--准备header</span></span><br><span class="line"><span class="keyword">elseif</span> id == <span class="number">3</span> <span class="keyword">then</span>    <span class="comment">--写header 、blank</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(hcache)   <span class="comment">--默认到stdout</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">"\r\n"</span>)</span><br><span class="line"><span class="keyword">elseif</span> id == <span class="number">4</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="built_in">tostring</span>(data1 <span class="keyword">or</span> <span class="string">""</span>))  <span class="comment">--写入body</span></span><br><span class="line"><span class="keyword">elseif</span> id == <span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">flush</span>()</span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">close</span>()</span><br><span class="line">    active = <span class="literal">false</span></span><br><span class="line"><span class="keyword">elseif</span> id == <span class="number">6</span> <span class="keyword">then</span></span><br><span class="line">    data1:copyz(nixio.<span class="built_in">stdout</span>, data2)</span><br><span class="line">    data1:<span class="built_in">close</span>()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>(4)、httpdispatch函数 /usr/lib/lua/luci/dispatcher.lua<br><a href="#dispatcher">dispatcher.lua文件完整代码</a>.</p>
<p>代码说明：整个代码主要关注一下函数</p>
<blockquote>
<p>1、httpdispatch函数   </p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">httpdispatch</span><span class="params">(request, prefix)</span></span></span><br><span class="line">    http.context.request = request</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> r = &#123;&#125;</span><br><span class="line">    context.request = r</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> pathinfo = http.urldecode(request:<span class="built_in">getenv</span>(<span class="string">"PATH_INFO"</span>) <span class="keyword">or</span> <span class="string">""</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> prefix <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> _, node <span class="keyword">in</span> <span class="built_in">ipairs</span>(prefix) <span class="keyword">do</span></span><br><span class="line">            r[#r+<span class="number">1</span>] = node</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> pathinfo:<span class="built_in">gmatch</span>(<span class="string">"[^/]+"</span>) <span class="keyword">do</span></span><br><span class="line">        r[#r+<span class="number">1</span>] = node</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> stat, err = util.coxpcall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        dispatch(context.request)</span><br><span class="line">    <span class="keyword">end</span>, error500)</span><br><span class="line"></span><br><span class="line">    http.<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">--context._disable_memtrace()</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>2、dispatch函数，</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(request)</span></span></span><br><span class="line">    <span class="comment">--context._disable_memtrace = require "luci.debug".trap_memtrace("l")</span></span><br><span class="line">    <span class="keyword">local</span> ctx = context</span><br><span class="line">    ctx.<span class="built_in">path</span> = request</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> conf = <span class="built_in">require</span> <span class="string">"luci.config"</span></span><br><span class="line">    <span class="built_in">assert</span>(conf.main,</span><br><span class="line">        <span class="string">"/etc/config/luci seems to be corrupt, unable to find section 'main'"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> i18n = <span class="built_in">require</span> <span class="string">"luci.i18n"</span></span><br><span class="line">    <span class="keyword">local</span> lang = conf.main.lang <span class="keyword">or</span> <span class="string">"auto"</span></span><br><span class="line">    <span class="keyword">if</span> lang == <span class="string">"auto"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> aclang = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_ACCEPT_LANGUAGE"</span>) <span class="keyword">or</span> <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> lpat <span class="keyword">in</span> aclang:<span class="built_in">gmatch</span>(<span class="string">"[%w-]+"</span>) <span class="keyword">do</span></span><br><span class="line">            lpat = lpat <span class="keyword">and</span> lpat:<span class="built_in">gsub</span>(<span class="string">"-"</span>, <span class="string">"_"</span>)</span><br><span class="line">            <span class="keyword">if</span> conf.languages[lpat] <span class="keyword">then</span></span><br><span class="line">                lang = lpat</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> lang == <span class="string">"auto"</span> <span class="keyword">then</span></span><br><span class="line">        lang = i18n.default</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    i18n.setlanguage(lang)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> c = ctx.tree</span><br><span class="line">    <span class="keyword">local</span> stat</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">        c = createtree()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> track = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> args = &#123;&#125;</span><br><span class="line">    ctx.args = args</span><br><span class="line">    ctx.requestargs = ctx.requestargs <span class="keyword">or</span> args</span><br><span class="line">    <span class="keyword">local</span> n</span><br><span class="line">    <span class="keyword">local</span> preq = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> freq = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, s <span class="keyword">in</span> <span class="built_in">ipairs</span>(request) <span class="keyword">do</span></span><br><span class="line">        preq[#preq+<span class="number">1</span>] = s</span><br><span class="line">        freq[#freq+<span class="number">1</span>] = s</span><br><span class="line">        c = c.nodes[s]</span><br><span class="line">        n = i</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        util.update(track, c)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> c.leaf <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> c.leaf <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> j=n+<span class="number">1</span>, #request <span class="keyword">do</span></span><br><span class="line">            args[#args+<span class="number">1</span>] = request[j]</span><br><span class="line">            freq[#freq+<span class="number">1</span>] = request[j]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    ctx.requestpath = ctx.requestpath <span class="keyword">or</span> freq</span><br><span class="line">    ctx.<span class="built_in">path</span> = preq</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.i18n <span class="keyword">then</span></span><br><span class="line">        i18n.loadc(track.i18n)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Init template engine</span></span><br><span class="line">    <span class="keyword">if</span> (c <span class="keyword">and</span> c.index) <span class="keyword">or</span> <span class="keyword">not</span> track.notemplate <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> tpl = <span class="built_in">require</span>(<span class="string">"luci.template"</span>)</span><br><span class="line">        <span class="keyword">local</span> media = track.mediaurlbase <span class="keyword">or</span> luci.<span class="built_in">config</span>.main.mediaurlbase</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">pcall</span>(tpl.Template, <span class="string">"themes/%s/header"</span> % fs.basename(media)) <span class="keyword">then</span></span><br><span class="line">            media = <span class="literal">nil</span></span><br><span class="line">            <span class="keyword">for</span> name, theme <span class="keyword">in</span> <span class="built_in">pairs</span>(luci.<span class="built_in">config</span>.themes) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> name:<span class="built_in">sub</span>(<span class="number">1</span>,<span class="number">1</span>) ~= <span class="string">"."</span> <span class="keyword">and</span> <span class="built_in">pcall</span>(tpl.Template,</span><br><span class="line">                 <span class="string">"themes/%s/header"</span> % fs.basename(theme)) <span class="keyword">then</span></span><br><span class="line">                    media = theme</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">assert</span>(media, <span class="string">"No valid theme found"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _ifattr<span class="params">(cond, key, val)</span></span></span><br><span class="line">            <span class="keyword">if</span> cond <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> env = <span class="built_in">getfenv</span>(<span class="number">3</span>)</span><br><span class="line">                <span class="keyword">local</span> scope = (<span class="built_in">type</span>(env.self) == <span class="string">"table"</span>) <span class="keyword">and</span> env.self</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">type</span>(val) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">next</span>(val) <span class="keyword">then</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        val = util.serialize_json(val)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">format</span>(</span><br><span class="line">                    <span class="string">' %s="%s"'</span>, <span class="built_in">tostring</span>(key),</span><br><span class="line">                    util.pcdata(<span class="built_in">tostring</span>( val</span><br><span class="line">                     <span class="keyword">or</span> (<span class="built_in">type</span>(env[key]) ~= <span class="string">"function"</span> <span class="keyword">and</span> env[key])</span><br><span class="line">                     <span class="keyword">or</span> (scope <span class="keyword">and</span> <span class="built_in">type</span>(scope[key]) ~= <span class="string">"function"</span> <span class="keyword">and</span> scope[key])</span><br><span class="line">                     <span class="keyword">or</span> <span class="string">""</span> ))</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        tpl.context.viewns = <span class="built_in">setmetatable</span>(&#123;</span><br><span class="line">           <span class="built_in">write</span>       = http.<span class="built_in">write</span>;</span><br><span class="line">           include     = <span class="function"><span class="keyword">function</span><span class="params">(name)</span></span> tpl.Template(name):render(<span class="built_in">getfenv</span>(<span class="number">2</span>)) <span class="keyword">end</span>;</span><br><span class="line">           translate   = i18n.translate;</span><br><span class="line">           translatef  = i18n.translatef;</span><br><span class="line">           export      = <span class="function"><span class="keyword">function</span><span class="params">(k, v)</span></span> <span class="keyword">if</span> tpl.context.viewns[k] == <span class="literal">nil</span> <span class="keyword">then</span> tpl.context.viewns[k] = v <span class="keyword">end</span> <span class="keyword">end</span>;</span><br><span class="line">           striptags   = util.striptags;</span><br><span class="line">           pcdata      = util.pcdata;</span><br><span class="line">           media       = media;</span><br><span class="line">           theme       = fs.basename(media);</span><br><span class="line">           resource    = luci.<span class="built_in">config</span>.main.resourcebase;</span><br><span class="line">           ifattr      = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span> <span class="keyword">return</span> _ifattr(...) <span class="keyword">end</span>;</span><br><span class="line">           attr        = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span> <span class="keyword">return</span> _ifattr(<span class="literal">true</span>, ...) <span class="keyword">end</span>;</span><br><span class="line">           url         = build_url;</span><br><span class="line">        &#125;, &#123;<span class="built_in">__index</span>=<span class="function"><span class="keyword">function</span><span class="params">(table, key)</span></span></span><br><span class="line">            <span class="keyword">if</span> key == <span class="string">"controller"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> build_url()</span><br><span class="line">            <span class="keyword">elseif</span> key == <span class="string">"REQUEST_URI"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> build_url(<span class="built_in">unpack</span>(ctx.requestpath))</span><br><span class="line">            <span class="keyword">elseif</span> key == <span class="string">"token"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> ctx.authtoken</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">rawget</span>(<span class="built_in">table</span>, key) <span class="keyword">or</span> <span class="built_in">_G</span>[key]</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    track.dependent = (track.dependent ~= <span class="literal">false</span>)</span><br><span class="line">    <span class="built_in">assert</span>(<span class="keyword">not</span> track.dependent <span class="keyword">or</span> <span class="keyword">not</span> track.auto,</span><br><span class="line">        <span class="string">"Access Violation\nThe page at '"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"/' "</span> ..</span><br><span class="line">        <span class="string">"has no parent node so the access to this location has been denied.\n"</span> ..</span><br><span class="line">        <span class="string">"This is a software bug, please report this message at "</span> ..</span><br><span class="line">        <span class="string">"https://github.com/openwrt/luci/issues"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.sysauth <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> authen = track.sysauth_authenticator</span><br><span class="line">        <span class="keyword">local</span> _, sid, sdat, default_user, allowed_users</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(authen) == <span class="string">"string"</span> <span class="keyword">and</span> authen ~= <span class="string">"htmlauth"</span> <span class="keyword">then</span></span><br><span class="line">            error500(<span class="string">"Unsupported authenticator %q configured"</span> % authen)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(track.sysauth) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            default_user, allowed_users = <span class="literal">nil</span>, track.sysauth</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            default_user, allowed_users = track.sysauth, &#123; track.sysauth &#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(authen) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">            _, sid = authen(sys.user.checkpasswd, allowed_users)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            sid = http.getcookie(<span class="string">"sysauth"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        sid, sdat = session_retrieve(sid, allowed_users)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (sid <span class="keyword">and</span> sdat) <span class="keyword">and</span> authen == <span class="string">"htmlauth"</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> user = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_AUTH_USER"</span>)</span><br><span class="line">            <span class="keyword">local</span> pass = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_AUTH_PASS"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> user == <span class="literal">nil</span> <span class="keyword">and</span> pass == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">                user = http.formvalue(<span class="string">"luci_username"</span>)</span><br><span class="line">                pass = http.formvalue(<span class="string">"luci_password"</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            sid, sdat = session_setup(user, pass, allowed_users)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> sid <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> tmpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line"></span><br><span class="line">                context.<span class="built_in">path</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">                http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">"Forbidden"</span>)</span><br><span class="line">                tmpl.render(track.sysauth_template <span class="keyword">or</span> <span class="string">"sysauth"</span>, &#123;</span><br><span class="line">                    duser = default_user,</span><br><span class="line">                    fuser = user</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            http.header(<span class="string">"Set-Cookie"</span>, <span class="string">'sysauth=%s; path=%s'</span> %&#123; sid, build_url() &#125;)</span><br><span class="line">            http.redirect(build_url(<span class="built_in">unpack</span>(ctx.requestpath)))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> sid <span class="keyword">or</span> <span class="keyword">not</span> sdat <span class="keyword">then</span></span><br><span class="line">            http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">"Forbidden"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        ctx.authsession = sid</span><br><span class="line">        ctx.authtoken = sdat.token</span><br><span class="line">        ctx.authuser = sdat.username</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> require_post_security(c.target) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> test_post_security(c) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.setgroup <span class="keyword">then</span></span><br><span class="line">        sys.process.setgroup(track.setgroup)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.setuser <span class="keyword">then</span></span><br><span class="line">        sys.process.setuser(track.setuser)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> target = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(c.target) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">            target = c.target</span><br><span class="line">        <span class="keyword">elseif</span> <span class="built_in">type</span>(c.target) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            target = c.target.target</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> (c.index <span class="keyword">or</span> <span class="built_in">type</span>(target) == <span class="string">"function"</span>) <span class="keyword">then</span></span><br><span class="line">        ctx.dispatched = c</span><br><span class="line">        ctx.requested = ctx.requested <span class="keyword">or</span> ctx.dispatched</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> c.index <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> tpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> util.copcall(tpl.render, <span class="string">"indexer"</span>, &#123;&#125;) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(target) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">        util.copcall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">            <span class="keyword">local</span> oldenv = <span class="built_in">getfenv</span>(target)</span><br><span class="line">            <span class="keyword">local</span> module = <span class="built_in">require</span>(c.module)</span><br><span class="line">            <span class="keyword">local</span> env = <span class="built_in">setmetatable</span>(&#123;&#125;, &#123;<span class="built_in">__index</span>=</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span><span class="params">(tbl, key)</span></span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">rawget</span>(tbl, key) <span class="keyword">or</span> module[key] <span class="keyword">or</span> oldenv[key]</span><br><span class="line">            <span class="keyword">end</span>&#125;)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">setfenv</span>(target, env)</span><br><span class="line">        <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> ok, err</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(c.target) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            ok, err = util.copcall(target, c.target, <span class="built_in">unpack</span>(args))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            ok, err = util.copcall(target, <span class="built_in">unpack</span>(args))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">assert</span>(ok,</span><br><span class="line">               <span class="string">"Failed to execute "</span> .. (<span class="built_in">type</span>(c.target) == <span class="string">"function"</span> <span class="keyword">and</span> <span class="string">"function"</span> <span class="keyword">or</span> c.target.<span class="built_in">type</span> <span class="keyword">or</span> <span class="string">"unknown"</span>) ..</span><br><span class="line">               <span class="string">" dispatcher target for entry '/"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"'.\n"</span> ..</span><br><span class="line">               <span class="string">"The called action terminated with an exception:\n"</span> .. <span class="built_in">tostring</span>(err <span class="keyword">or</span> <span class="string">"(unknown)"</span>))</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> root = node()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root <span class="keyword">or</span> <span class="keyword">not</span> root.target <span class="keyword">then</span></span><br><span class="line">            error404(<span class="string">"No root node was registered, this usually happens if no module was installed.\n"</span> ..</span><br><span class="line">                     <span class="string">"Install luci-mod-admin-full and retry. "</span> ..</span><br><span class="line">                     <span class="string">"If the module is already installed, try removing the /tmp/luci-indexcache file."</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            error404(<span class="string">"No page is registered at '/"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"'.\n"</span> ..</span><br><span class="line">                     <span class="string">"If this url belongs to an extension, make sure it is properly installed.\n"</span> ..</span><br><span class="line">                     <span class="string">"If the extension was recently installed, try removing the /tmp/luci-indexcache file."</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">代码：</span><br><span class="line"></span><br><span class="line">&lt;div id=<span class="string">"cgi"</span>&gt;cgi.lua完整代码如下：&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">```lua</span><br><span class="line"><span class="comment">-- Copyright 2008 Steven Barth &lt;steven@midlink.org&gt;</span></span><br><span class="line"><span class="comment">-- Licensed to the public under the Apache License 2.0.</span></span><br><span class="line"></span><br><span class="line">exectime = <span class="built_in">os</span>.<span class="built_in">clock</span>()</span><br><span class="line">module(<span class="string">"luci.sgi.cgi"</span>, <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"><span class="keyword">local</span> ltn12 = <span class="built_in">require</span>(<span class="string">"luci.ltn12"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"nixio.util"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"luci.http"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"luci.sys"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"luci.dispatcher"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Limited source to avoid endless blocking</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">limitsource</span><span class="params">(handle, limit)</span></span></span><br><span class="line">    limit = limit <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">local</span> BLOCKSIZE = ltn12.BLOCKSIZE</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        <span class="keyword">if</span> limit &lt; <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">            handle:<span class="built_in">close</span>()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">local</span> <span class="built_in">read</span> = (limit &gt; BLOCKSIZE) <span class="keyword">and</span> BLOCKSIZE <span class="keyword">or</span> limit</span><br><span class="line">            limit = limit - <span class="built_in">read</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">local</span> chunk = handle:<span class="built_in">read</span>(<span class="built_in">read</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chunk <span class="keyword">then</span> handle:<span class="built_in">close</span>() <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> chunk</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> r = luci.http.Request(</span><br><span class="line">        luci.sys.<span class="built_in">getenv</span>(),</span><br><span class="line">        limitsource(<span class="built_in">io</span>.<span class="built_in">stdin</span>, <span class="built_in">tonumber</span>(luci.sys.<span class="built_in">getenv</span>(<span class="string">"CONTENT_LENGTH"</span>))),</span><br><span class="line">        ltn12.sink.file(<span class="built_in">io</span>.<span class="built_in">stderr</span>)</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> x = coroutine.<span class="built_in">create</span>(luci.dispatcher.httpdispatch)</span><br><span class="line">    <span class="keyword">local</span> hcache = <span class="string">""</span></span><br><span class="line">    <span class="keyword">local</span> active = <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> coroutine.<span class="built_in">status</span>(x) ~= <span class="string">"dead"</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> res, id, data1, data2 = coroutine.<span class="built_in">resume</span>(x, r)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Status: 500 Internal Server Error"</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Content-Type: text/plain\n"</span>)</span><br><span class="line">            <span class="built_in">print</span>(id)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> active <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> id == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">"Status: "</span> .. <span class="built_in">tostring</span>(data1) .. <span class="string">" "</span> .. data2 .. <span class="string">"\r\n"</span>)</span><br><span class="line">            <span class="keyword">elseif</span> id == <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">                hcache = hcache .. data1 .. <span class="string">": "</span> .. data2 .. <span class="string">"\r\n"</span></span><br><span class="line">            <span class="keyword">elseif</span> id == <span class="number">3</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">write</span>(hcache)</span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">"\r\n"</span>)</span><br><span class="line">            <span class="keyword">elseif</span> id == <span class="number">4</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="built_in">tostring</span>(data1 <span class="keyword">or</span> <span class="string">""</span>))</span><br><span class="line">            <span class="keyword">elseif</span> id == <span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">flush</span>()</span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">close</span>()</span><br><span class="line">                active = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">elseif</span> id == <span class="number">6</span> <span class="keyword">then</span></span><br><span class="line">                data1:copyz(nixio.<span class="built_in">stdout</span>, data2)</span><br><span class="line">                data1:<span class="built_in">close</span>()</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<div id="dispatcher">dispatcher.lua完整代码如下：</div>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Copyright 2008 Steven Barth &lt;steven@midlink.org&gt;</span></span><br><span class="line"><span class="comment">-- Copyright 2008-2015 Jo-Philipp Wich &lt;jow@openwrt.org&gt;</span></span><br><span class="line"><span class="comment">-- Licensed to the public under the Apache License 2.0.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> fs = <span class="built_in">require</span> <span class="string">"nixio.fs"</span></span><br><span class="line"><span class="keyword">local</span> sys = <span class="built_in">require</span> <span class="string">"luci.sys"</span></span><br><span class="line"><span class="keyword">local</span> util = <span class="built_in">require</span> <span class="string">"luci.util"</span></span><br><span class="line"><span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">"luci.http"</span></span><br><span class="line"><span class="keyword">local</span> nixio = <span class="built_in">require</span> <span class="string">"nixio"</span>, <span class="built_in">require</span> <span class="string">"nixio.util"</span></span><br><span class="line"></span><br><span class="line">module(<span class="string">"luci.dispatcher"</span>, <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line">context = util.threadlocal()</span><br><span class="line">uci = <span class="built_in">require</span> <span class="string">"luci.model.uci"</span></span><br><span class="line">i18n = <span class="built_in">require</span> <span class="string">"luci.i18n"</span></span><br><span class="line">_M.fs = fs</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Index table</span></span><br><span class="line"><span class="keyword">local</span> index = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Fastindex</span></span><br><span class="line"><span class="keyword">local</span> fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">build_url</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">path</span> = &#123;...&#125;</span><br><span class="line">    <span class="keyword">local</span> url = &#123; http.<span class="built_in">getenv</span>(<span class="string">"SCRIPT_NAME"</span>) <span class="keyword">or</span> <span class="string">""</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> p</span><br><span class="line">    <span class="keyword">for</span> _, p <span class="keyword">in</span> <span class="built_in">ipairs</span>(<span class="built_in">path</span>) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> p:<span class="built_in">match</span>(<span class="string">"^[a-zA-Z0-9_%-%.%%/,;]+$"</span>) <span class="keyword">then</span></span><br><span class="line">            url[#url+<span class="number">1</span>] = <span class="string">"/"</span></span><br><span class="line">            url[#url+<span class="number">1</span>] = p</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> #<span class="built_in">path</span> == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        url[#url+<span class="number">1</span>] = <span class="string">"/"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">table</span>.<span class="built_in">concat</span>(url, <span class="string">""</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">node_visible</span><span class="params">(node)</span></span></span><br><span class="line">   <span class="keyword">if</span> node <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">not</span> (</span><br><span class="line">         (<span class="keyword">not</span> node.title <span class="keyword">or</span> #node.title == <span class="number">0</span>) <span class="keyword">or</span></span><br><span class="line">         (<span class="keyword">not</span> node.target <span class="keyword">or</span> node.hidden == <span class="literal">true</span>) <span class="keyword">or</span></span><br><span class="line">         (<span class="built_in">type</span>(node.target) == <span class="string">"table"</span> <span class="keyword">and</span> node.target.<span class="built_in">type</span> == <span class="string">"firstchild"</span> <span class="keyword">and</span></span><br><span class="line">          (<span class="built_in">type</span>(node.nodes) ~= <span class="string">"table"</span> <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">next</span>(node.nodes)))</span><br><span class="line">      )</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">node_childs</span><span class="params">(node)</span></span></span><br><span class="line">    <span class="keyword">local</span> rv = &#123; &#125;</span><br><span class="line">    <span class="keyword">if</span> node <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> k, v</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> util.spairs(node.nodes,</span><br><span class="line">            <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span></span></span><br><span class="line">                <span class="keyword">return</span> (node.nodes[a].order <span class="keyword">or</span> <span class="number">100</span>)</span><br><span class="line">                     &lt; (node.nodes[b].order <span class="keyword">or</span> <span class="number">100</span>)</span><br><span class="line">            <span class="keyword">end</span>)</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> node_visible(v) <span class="keyword">then</span></span><br><span class="line">                rv[#rv+<span class="number">1</span>] = k</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> rv</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error404</span><span class="params">(message)</span></span></span><br><span class="line">    http.<span class="built_in">status</span>(<span class="number">404</span>, <span class="string">"Not Found"</span>)</span><br><span class="line">    message = message <span class="keyword">or</span> <span class="string">"Not Found"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">"luci.template"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> util.copcall(luci.template.render, <span class="string">"error404"</span>) <span class="keyword">then</span></span><br><span class="line">        http.prepare_content(<span class="string">"text/plain"</span>)</span><br><span class="line">        http.<span class="built_in">write</span>(message)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error500</span><span class="params">(message)</span></span></span><br><span class="line">    util.perror(message)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> context.template_header_sent <span class="keyword">then</span></span><br><span class="line">        http.<span class="built_in">status</span>(<span class="number">500</span>, <span class="string">"Internal Server Error"</span>)</span><br><span class="line">        http.prepare_content(<span class="string">"text/plain"</span>)</span><br><span class="line">        http.<span class="built_in">write</span>(message)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">require</span>(<span class="string">"luci.template"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> util.copcall(luci.template.render, <span class="string">"error500"</span>, &#123;message=message&#125;) <span class="keyword">then</span></span><br><span class="line">            http.prepare_content(<span class="string">"text/plain"</span>)</span><br><span class="line">            http.<span class="built_in">write</span>(message)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">httpdispatch</span><span class="params">(request, prefix)</span></span></span><br><span class="line">    http.context.request = request</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> r = &#123;&#125;</span><br><span class="line">    context.request = r</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> pathinfo = http.urldecode(request:<span class="built_in">getenv</span>(<span class="string">"PATH_INFO"</span>) <span class="keyword">or</span> <span class="string">""</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> prefix <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> _, node <span class="keyword">in</span> <span class="built_in">ipairs</span>(prefix) <span class="keyword">do</span></span><br><span class="line">            r[#r+<span class="number">1</span>] = node</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> pathinfo:<span class="built_in">gmatch</span>(<span class="string">"[^/]+"</span>) <span class="keyword">do</span></span><br><span class="line">        r[#r+<span class="number">1</span>] = node</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> stat, err = util.coxpcall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        dispatch(context.request)</span><br><span class="line">    <span class="keyword">end</span>, error500)</span><br><span class="line"></span><br><span class="line">    http.<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">--context._disable_memtrace()</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">require_post_security</span><span class="params">(target)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(target) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(target.post) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> param_name, required_val, request_val</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> param_name, required_val <span class="keyword">in</span> <span class="built_in">pairs</span>(target.post) <span class="keyword">do</span></span><br><span class="line">                request_val = http.formvalue(param_name)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">type</span>(required_val) == <span class="string">"string"</span> <span class="keyword">and</span></span><br><span class="line">                    request_val ~= required_val) <span class="keyword">or</span></span><br><span class="line">                   (required_val == <span class="literal">true</span> <span class="keyword">and</span></span><br><span class="line">                    (request_val == <span class="literal">nil</span> <span class="keyword">or</span> request_val == <span class="string">""</span>))</span><br><span class="line">                <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (target.post == <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test_post_security</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> http.<span class="built_in">getenv</span>(<span class="string">"REQUEST_METHOD"</span>) ~= <span class="string">"POST"</span> <span class="keyword">then</span></span><br><span class="line">        http.<span class="built_in">status</span>(<span class="number">405</span>, <span class="string">"Method Not Allowed"</span>)</span><br><span class="line">        http.header(<span class="string">"Allow"</span>, <span class="string">"POST"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> http.formvalue(<span class="string">"token"</span>) ~= context.authtoken <span class="keyword">then</span></span><br><span class="line">        http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">"Forbidden"</span>)</span><br><span class="line">        luci.template.render(<span class="string">"csrftoken"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">session_retrieve</span><span class="params">(sid, allowed_users)</span></span></span><br><span class="line">    <span class="keyword">local</span> sdat = util.ubus(<span class="string">"session"</span>, <span class="string">"get"</span>, &#123; ubus_rpc_session = sid &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(sdat) == <span class="string">"table"</span> <span class="keyword">and</span></span><br><span class="line">       <span class="built_in">type</span>(sdat.values) == <span class="string">"table"</span> <span class="keyword">and</span></span><br><span class="line">       <span class="built_in">type</span>(sdat.values.token) == <span class="string">"string"</span> <span class="keyword">and</span></span><br><span class="line">       (<span class="keyword">not</span> allowed_users <span class="keyword">or</span></span><br><span class="line">        util.contains(allowed_users, sdat.values.username))</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> sid, sdat.values</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">session_setup</span><span class="params">(user, pass, allowed_users)</span></span></span><br><span class="line">    <span class="keyword">if</span> util.contains(allowed_users, user) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> login = util.ubus(<span class="string">"session"</span>, <span class="string">"login"</span>, &#123;</span><br><span class="line">            username = user,</span><br><span class="line">            password = pass,</span><br><span class="line">            timeout  = <span class="built_in">tonumber</span>(luci.<span class="built_in">config</span>.sauth.sessiontime)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(login) == <span class="string">"table"</span> <span class="keyword">and</span></span><br><span class="line">           <span class="built_in">type</span>(login.ubus_rpc_session) == <span class="string">"string"</span></span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            util.ubus(<span class="string">"session"</span>, <span class="string">"set"</span>, &#123;</span><br><span class="line">                ubus_rpc_session = login.ubus_rpc_session,</span><br><span class="line">                values = &#123; token = sys.uniqueid(<span class="number">16</span>) &#125;</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> session_retrieve(login.ubus_rpc_session)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(request)</span></span></span><br><span class="line">    <span class="comment">--context._disable_memtrace = require "luci.debug".trap_memtrace("l")</span></span><br><span class="line">    <span class="keyword">local</span> ctx = context</span><br><span class="line">    ctx.<span class="built_in">path</span> = request</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> conf = <span class="built_in">require</span> <span class="string">"luci.config"</span></span><br><span class="line">    <span class="built_in">assert</span>(conf.main,</span><br><span class="line">        <span class="string">"/etc/config/luci seems to be corrupt, unable to find section 'main'"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> i18n = <span class="built_in">require</span> <span class="string">"luci.i18n"</span></span><br><span class="line">    <span class="keyword">local</span> lang = conf.main.lang <span class="keyword">or</span> <span class="string">"auto"</span></span><br><span class="line">    <span class="keyword">if</span> lang == <span class="string">"auto"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> aclang = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_ACCEPT_LANGUAGE"</span>) <span class="keyword">or</span> <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> lpat <span class="keyword">in</span> aclang:<span class="built_in">gmatch</span>(<span class="string">"[%w-]+"</span>) <span class="keyword">do</span></span><br><span class="line">            lpat = lpat <span class="keyword">and</span> lpat:<span class="built_in">gsub</span>(<span class="string">"-"</span>, <span class="string">"_"</span>)</span><br><span class="line">            <span class="keyword">if</span> conf.languages[lpat] <span class="keyword">then</span></span><br><span class="line">                lang = lpat</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> lang == <span class="string">"auto"</span> <span class="keyword">then</span></span><br><span class="line">        lang = i18n.default</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    i18n.setlanguage(lang)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> c = ctx.tree</span><br><span class="line">    <span class="keyword">local</span> stat</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">        c = createtree()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> track = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> args = &#123;&#125;</span><br><span class="line">    ctx.args = args</span><br><span class="line">    ctx.requestargs = ctx.requestargs <span class="keyword">or</span> args</span><br><span class="line">    <span class="keyword">local</span> n</span><br><span class="line">    <span class="keyword">local</span> preq = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> freq = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, s <span class="keyword">in</span> <span class="built_in">ipairs</span>(request) <span class="keyword">do</span></span><br><span class="line">        preq[#preq+<span class="number">1</span>] = s</span><br><span class="line">        freq[#freq+<span class="number">1</span>] = s</span><br><span class="line">        c = c.nodes[s]</span><br><span class="line">        n = i</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        util.update(track, c)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> c.leaf <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> c.leaf <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> j=n+<span class="number">1</span>, #request <span class="keyword">do</span></span><br><span class="line">            args[#args+<span class="number">1</span>] = request[j]</span><br><span class="line">            freq[#freq+<span class="number">1</span>] = request[j]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    ctx.requestpath = ctx.requestpath <span class="keyword">or</span> freq</span><br><span class="line">    ctx.<span class="built_in">path</span> = preq</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.i18n <span class="keyword">then</span></span><br><span class="line">        i18n.loadc(track.i18n)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Init template engine</span></span><br><span class="line">    <span class="keyword">if</span> (c <span class="keyword">and</span> c.index) <span class="keyword">or</span> <span class="keyword">not</span> track.notemplate <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> tpl = <span class="built_in">require</span>(<span class="string">"luci.template"</span>)</span><br><span class="line">        <span class="keyword">local</span> media = track.mediaurlbase <span class="keyword">or</span> luci.<span class="built_in">config</span>.main.mediaurlbase</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">pcall</span>(tpl.Template, <span class="string">"themes/%s/header"</span> % fs.basename(media)) <span class="keyword">then</span></span><br><span class="line">            media = <span class="literal">nil</span></span><br><span class="line">            <span class="keyword">for</span> name, theme <span class="keyword">in</span> <span class="built_in">pairs</span>(luci.<span class="built_in">config</span>.themes) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> name:<span class="built_in">sub</span>(<span class="number">1</span>,<span class="number">1</span>) ~= <span class="string">"."</span> <span class="keyword">and</span> <span class="built_in">pcall</span>(tpl.Template,</span><br><span class="line">                 <span class="string">"themes/%s/header"</span> % fs.basename(theme)) <span class="keyword">then</span></span><br><span class="line">                    media = theme</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">assert</span>(media, <span class="string">"No valid theme found"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _ifattr<span class="params">(cond, key, val)</span></span></span><br><span class="line">            <span class="keyword">if</span> cond <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> env = <span class="built_in">getfenv</span>(<span class="number">3</span>)</span><br><span class="line">                <span class="keyword">local</span> scope = (<span class="built_in">type</span>(env.self) == <span class="string">"table"</span>) <span class="keyword">and</span> env.self</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">type</span>(val) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">next</span>(val) <span class="keyword">then</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        val = util.serialize_json(val)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">format</span>(</span><br><span class="line">                    <span class="string">' %s="%s"'</span>, <span class="built_in">tostring</span>(key),</span><br><span class="line">                    util.pcdata(<span class="built_in">tostring</span>( val</span><br><span class="line">                     <span class="keyword">or</span> (<span class="built_in">type</span>(env[key]) ~= <span class="string">"function"</span> <span class="keyword">and</span> env[key])</span><br><span class="line">                     <span class="keyword">or</span> (scope <span class="keyword">and</span> <span class="built_in">type</span>(scope[key]) ~= <span class="string">"function"</span> <span class="keyword">and</span> scope[key])</span><br><span class="line">                     <span class="keyword">or</span> <span class="string">""</span> ))</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        tpl.context.viewns = <span class="built_in">setmetatable</span>(&#123;</span><br><span class="line">           <span class="built_in">write</span>       = http.<span class="built_in">write</span>;</span><br><span class="line">           include     = <span class="function"><span class="keyword">function</span><span class="params">(name)</span></span> tpl.Template(name):render(<span class="built_in">getfenv</span>(<span class="number">2</span>)) <span class="keyword">end</span>;</span><br><span class="line">           translate   = i18n.translate;</span><br><span class="line">           translatef  = i18n.translatef;</span><br><span class="line">           export      = <span class="function"><span class="keyword">function</span><span class="params">(k, v)</span></span> <span class="keyword">if</span> tpl.context.viewns[k] == <span class="literal">nil</span> <span class="keyword">then</span> tpl.context.viewns[k] = v <span class="keyword">end</span> <span class="keyword">end</span>;</span><br><span class="line">           striptags   = util.striptags;</span><br><span class="line">           pcdata      = util.pcdata;</span><br><span class="line">           media       = media;</span><br><span class="line">           theme       = fs.basename(media);</span><br><span class="line">           resource    = luci.<span class="built_in">config</span>.main.resourcebase;</span><br><span class="line">           ifattr      = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span> <span class="keyword">return</span> _ifattr(...) <span class="keyword">end</span>;</span><br><span class="line">           attr        = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span> <span class="keyword">return</span> _ifattr(<span class="literal">true</span>, ...) <span class="keyword">end</span>;</span><br><span class="line">           url         = build_url;</span><br><span class="line">        &#125;, &#123;<span class="built_in">__index</span>=<span class="function"><span class="keyword">function</span><span class="params">(table, key)</span></span></span><br><span class="line">            <span class="keyword">if</span> key == <span class="string">"controller"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> build_url()</span><br><span class="line">            <span class="keyword">elseif</span> key == <span class="string">"REQUEST_URI"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> build_url(<span class="built_in">unpack</span>(ctx.requestpath))</span><br><span class="line">            <span class="keyword">elseif</span> key == <span class="string">"token"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> ctx.authtoken</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">rawget</span>(<span class="built_in">table</span>, key) <span class="keyword">or</span> <span class="built_in">_G</span>[key]</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    track.dependent = (track.dependent ~= <span class="literal">false</span>)</span><br><span class="line">    <span class="built_in">assert</span>(<span class="keyword">not</span> track.dependent <span class="keyword">or</span> <span class="keyword">not</span> track.auto,</span><br><span class="line">        <span class="string">"Access Violation\nThe page at '"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"/' "</span> ..</span><br><span class="line">        <span class="string">"has no parent node so the access to this location has been denied.\n"</span> ..</span><br><span class="line">        <span class="string">"This is a software bug, please report this message at "</span> ..</span><br><span class="line">        <span class="string">"https://github.com/openwrt/luci/issues"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.sysauth <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> authen = track.sysauth_authenticator</span><br><span class="line">        <span class="keyword">local</span> _, sid, sdat, default_user, allowed_users</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(authen) == <span class="string">"string"</span> <span class="keyword">and</span> authen ~= <span class="string">"htmlauth"</span> <span class="keyword">then</span></span><br><span class="line">            error500(<span class="string">"Unsupported authenticator %q configured"</span> % authen)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(track.sysauth) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            default_user, allowed_users = <span class="literal">nil</span>, track.sysauth</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            default_user, allowed_users = track.sysauth, &#123; track.sysauth &#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(authen) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">            _, sid = authen(sys.user.checkpasswd, allowed_users)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            sid = http.getcookie(<span class="string">"sysauth"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        sid, sdat = session_retrieve(sid, allowed_users)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (sid <span class="keyword">and</span> sdat) <span class="keyword">and</span> authen == <span class="string">"htmlauth"</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> user = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_AUTH_USER"</span>)</span><br><span class="line">            <span class="keyword">local</span> pass = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_AUTH_PASS"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> user == <span class="literal">nil</span> <span class="keyword">and</span> pass == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">                user = http.formvalue(<span class="string">"luci_username"</span>)</span><br><span class="line">                pass = http.formvalue(<span class="string">"luci_password"</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            sid, sdat = session_setup(user, pass, allowed_users)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> sid <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> tmpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line"></span><br><span class="line">                context.<span class="built_in">path</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">                http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">"Forbidden"</span>)</span><br><span class="line">                tmpl.render(track.sysauth_template <span class="keyword">or</span> <span class="string">"sysauth"</span>, &#123;</span><br><span class="line">                    duser = default_user,</span><br><span class="line">                    fuser = user</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            http.header(<span class="string">"Set-Cookie"</span>, <span class="string">'sysauth=%s; path=%s'</span> %&#123; sid, build_url() &#125;)</span><br><span class="line">            http.redirect(build_url(<span class="built_in">unpack</span>(ctx.requestpath)))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> sid <span class="keyword">or</span> <span class="keyword">not</span> sdat <span class="keyword">then</span></span><br><span class="line">            http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">"Forbidden"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        ctx.authsession = sid</span><br><span class="line">        ctx.authtoken = sdat.token</span><br><span class="line">        ctx.authuser = sdat.username</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> require_post_security(c.target) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> test_post_security(c) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.setgroup <span class="keyword">then</span></span><br><span class="line">        sys.process.setgroup(track.setgroup)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.setuser <span class="keyword">then</span></span><br><span class="line">        sys.process.setuser(track.setuser)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> target = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(c.target) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">            target = c.target</span><br><span class="line">        <span class="keyword">elseif</span> <span class="built_in">type</span>(c.target) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            target = c.target.target</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> (c.index <span class="keyword">or</span> <span class="built_in">type</span>(target) == <span class="string">"function"</span>) <span class="keyword">then</span></span><br><span class="line">        ctx.dispatched = c</span><br><span class="line">        ctx.requested = ctx.requested <span class="keyword">or</span> ctx.dispatched</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> c.index <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> tpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> util.copcall(tpl.render, <span class="string">"indexer"</span>, &#123;&#125;) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(target) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">        util.copcall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">            <span class="keyword">local</span> oldenv = <span class="built_in">getfenv</span>(target)</span><br><span class="line">            <span class="keyword">local</span> module = <span class="built_in">require</span>(c.module)</span><br><span class="line">            <span class="keyword">local</span> env = <span class="built_in">setmetatable</span>(&#123;&#125;, &#123;<span class="built_in">__index</span>=</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span><span class="params">(tbl, key)</span></span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">rawget</span>(tbl, key) <span class="keyword">or</span> module[key] <span class="keyword">or</span> oldenv[key]</span><br><span class="line">            <span class="keyword">end</span>&#125;)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">setfenv</span>(target, env)</span><br><span class="line">        <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> ok, err</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(c.target) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            ok, err = util.copcall(target, c.target, <span class="built_in">unpack</span>(args))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            ok, err = util.copcall(target, <span class="built_in">unpack</span>(args))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">assert</span>(ok,</span><br><span class="line">               <span class="string">"Failed to execute "</span> .. (<span class="built_in">type</span>(c.target) == <span class="string">"function"</span> <span class="keyword">and</span> <span class="string">"function"</span> <span class="keyword">or</span> c.target.<span class="built_in">type</span> <span class="keyword">or</span> <span class="string">"unknown"</span>) ..</span><br><span class="line">               <span class="string">" dispatcher target for entry '/"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"'.\n"</span> ..</span><br><span class="line">               <span class="string">"The called action terminated with an exception:\n"</span> .. <span class="built_in">tostring</span>(err <span class="keyword">or</span> <span class="string">"(unknown)"</span>))</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> root = node()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root <span class="keyword">or</span> <span class="keyword">not</span> root.target <span class="keyword">then</span></span><br><span class="line">            error404(<span class="string">"No root node was registered, this usually happens if no module was installed.\n"</span> ..</span><br><span class="line">                     <span class="string">"Install luci-mod-admin-full and retry. "</span> ..</span><br><span class="line">                     <span class="string">"If the module is already installed, try removing the /tmp/luci-indexcache file."</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            error404(<span class="string">"No page is registered at '/"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"'.\n"</span> ..</span><br><span class="line">                     <span class="string">"If this url belongs to an extension, make sure it is properly installed.\n"</span> ..</span><br><span class="line">                     <span class="string">"If the extension was recently installed, try removing the /tmp/luci-indexcache file."</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createindex</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> controllers = &#123; &#125;</span><br><span class="line">    <span class="keyword">local</span> base = <span class="string">"%s/controller/"</span> % util.libpath()</span><br><span class="line">    <span class="keyword">local</span> _, <span class="built_in">path</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">path</span> <span class="keyword">in</span> (fs.glob(<span class="string">"%s*.lua"</span> % base) <span class="keyword">or</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>) <span class="keyword">do</span></span><br><span class="line">        controllers[#controllers+<span class="number">1</span>] = <span class="built_in">path</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">path</span> <span class="keyword">in</span> (fs.glob(<span class="string">"%s*/*.lua"</span> % base) <span class="keyword">or</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>) <span class="keyword">do</span></span><br><span class="line">        controllers[#controllers+<span class="number">1</span>] = <span class="built_in">path</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> indexcache <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> cachedate = fs.stat(indexcache, <span class="string">"mtime"</span>)</span><br><span class="line">        <span class="keyword">if</span> cachedate <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> realdate = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> _, obj <span class="keyword">in</span> <span class="built_in">ipairs</span>(controllers) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">local</span> omtime = fs.stat(obj, <span class="string">"mtime"</span>)</span><br><span class="line">                realdate = (omtime <span class="keyword">and</span> omtime &gt; realdate) <span class="keyword">and</span> omtime <span class="keyword">or</span> realdate</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> cachedate &gt; realdate <span class="keyword">and</span> sys.process.info(<span class="string">"uid"</span>) == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">assert</span>(</span><br><span class="line">                    sys.process.info(<span class="string">"uid"</span>) == fs.stat(indexcache, <span class="string">"uid"</span>)</span><br><span class="line">                    <span class="keyword">and</span> fs.stat(indexcache, <span class="string">"modestr"</span>) == <span class="string">"rw-------"</span>,</span><br><span class="line">                    <span class="string">"Fatal: Indexcache is not sane!"</span></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">                index = <span class="built_in">loadfile</span>(indexcache)()</span><br><span class="line">                <span class="keyword">return</span> index</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    index = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, <span class="built_in">path</span> <span class="keyword">in</span> <span class="built_in">ipairs</span>(controllers) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> modname = <span class="string">"luci.controller."</span> .. <span class="built_in">path</span>:<span class="built_in">sub</span>(#base+<span class="number">1</span>, #<span class="built_in">path</span><span class="number">-4</span>):<span class="built_in">gsub</span>(<span class="string">"/"</span>, <span class="string">"."</span>)</span><br><span class="line">        <span class="keyword">local</span> <span class="built_in">mod</span> = <span class="built_in">require</span>(modname)</span><br><span class="line">        <span class="built_in">assert</span>(<span class="built_in">mod</span> ~= <span class="literal">true</span>,</span><br><span class="line">               <span class="string">"Invalid controller file found\n"</span> ..</span><br><span class="line">               <span class="string">"The file '"</span> .. <span class="built_in">path</span> .. <span class="string">"' contains an invalid module line.\n"</span> ..</span><br><span class="line">               <span class="string">"Please verify whether the module name is set to '"</span> .. modname ..</span><br><span class="line">               <span class="string">"' - It must correspond to the file path!"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> idx = <span class="built_in">mod</span>.index</span><br><span class="line">        <span class="built_in">assert</span>(<span class="built_in">type</span>(idx) == <span class="string">"function"</span>,</span><br><span class="line">               <span class="string">"Invalid controller file found\n"</span> ..</span><br><span class="line">               <span class="string">"The file '"</span> .. <span class="built_in">path</span> .. <span class="string">"' contains no index() function.\n"</span> ..</span><br><span class="line">               <span class="string">"Please make sure that the controller contains a valid "</span> ..</span><br><span class="line">               <span class="string">"index function and verify the spelling!"</span>)</span><br><span class="line"></span><br><span class="line">        index[modname] = idx</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> indexcache <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> f = nixio.<span class="built_in">open</span>(indexcache, <span class="string">"w"</span>, <span class="number">600</span>)</span><br><span class="line">        f:writeall(util.get_bytecode(index))</span><br><span class="line">        f:<span class="built_in">close</span>()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Build the index before if it does not exist yet.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createtree</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> index <span class="keyword">then</span></span><br><span class="line">        createindex()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> ctx  = context</span><br><span class="line">    <span class="keyword">local</span> tree = &#123;nodes=&#123;&#125;, inreq=<span class="literal">true</span>&#125;</span><br><span class="line">    <span class="keyword">local</span> modi = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    ctx.treecache = <span class="built_in">setmetatable</span>(&#123;&#125;, &#123;<span class="built_in">__mode</span>=<span class="string">"v"</span>&#125;)</span><br><span class="line">    ctx.tree = tree</span><br><span class="line">    ctx.modifiers = modi</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Load default translation</span></span><br><span class="line">    <span class="built_in">require</span> <span class="string">"luci.i18n"</span>.loadc(<span class="string">"base"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> scope = <span class="built_in">setmetatable</span>(&#123;&#125;, &#123;<span class="built_in">__index</span> = luci.dispatcher&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(index) <span class="keyword">do</span></span><br><span class="line">        scope._NAME = k</span><br><span class="line">        <span class="built_in">setfenv</span>(v, scope)</span><br><span class="line">        v()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">modisort</span><span class="params">(a,b)</span></span></span><br><span class="line">        <span class="keyword">return</span> modi[a].order &lt; modi[b].order</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, v <span class="keyword">in</span> util.spairs(modi, modisort) <span class="keyword">do</span></span><br><span class="line">        scope._NAME = v.module</span><br><span class="line">        <span class="built_in">setfenv</span>(v.func, scope)</span><br><span class="line">        v.func()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tree</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">modifier</span><span class="params">(func, order)</span></span></span><br><span class="line">    context.modifiers[#context.modifiers+<span class="number">1</span>] = &#123;</span><br><span class="line">        func = func,</span><br><span class="line">        order = order <span class="keyword">or</span> <span class="number">0</span>,</span><br><span class="line">        module</span><br><span class="line">            = <span class="built_in">getfenv</span>(<span class="number">2</span>)._NAME</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">assign</span><span class="params">(path, clone, title, order)</span></span></span><br><span class="line">    <span class="keyword">local</span> obj  = node(<span class="built_in">unpack</span>(<span class="built_in">path</span>))</span><br><span class="line">    obj.nodes  = <span class="literal">nil</span></span><br><span class="line">    obj.module = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    obj.title = title</span><br><span class="line">    obj.order = order</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setmetatable</span>(obj, &#123;<span class="built_in">__index</span> = _create_node(clone)&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">entry</span><span class="params">(path, target, title, order)</span></span></span><br><span class="line">    <span class="keyword">local</span> c = node(<span class="built_in">unpack</span>(<span class="built_in">path</span>))</span><br><span class="line"></span><br><span class="line">    c.target = target</span><br><span class="line">    c.title  = title</span><br><span class="line">    c.order  = order</span><br><span class="line">    c.module = <span class="built_in">getfenv</span>(<span class="number">2</span>)._NAME</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- enabling the node.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">return</span> _create_node(&#123;...&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">node</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> c = _create_node(&#123;...&#125;)</span><br><span class="line"></span><br><span class="line">    c.module = <span class="built_in">getfenv</span>(<span class="number">2</span>)._NAME</span><br><span class="line">    c.auto = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> _create_node<span class="params">(path)</span></span></span><br><span class="line">    <span class="keyword">if</span> #<span class="built_in">path</span> == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> context.tree</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> name = <span class="built_in">table</span>.<span class="built_in">concat</span>(<span class="built_in">path</span>, <span class="string">"."</span>)</span><br><span class="line">    <span class="keyword">local</span> c = context.treecache[name]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> last = <span class="built_in">table</span>.<span class="built_in">remove</span>(<span class="built_in">path</span>)</span><br><span class="line">        <span class="keyword">local</span> parent = _create_node(<span class="built_in">path</span>)</span><br><span class="line"></span><br><span class="line">        c = &#123;nodes=&#123;&#125;, auto=<span class="literal">true</span>&#125;</span><br><span class="line">        <span class="comment">-- the node is "in request" if the request path matches</span></span><br><span class="line">        <span class="comment">-- at least up to the length of the node path</span></span><br><span class="line">        <span class="keyword">if</span> parent.inreq <span class="keyword">and</span> context.<span class="built_in">path</span>[#<span class="built_in">path</span>+<span class="number">1</span>] == last <span class="keyword">then</span></span><br><span class="line">          c.inreq = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        parent.nodes[last] = c</span><br><span class="line">        context.treecache[name] = c</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Subdispatchers --</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> _firstchild<span class="params">()</span></span></span><br><span class="line">   <span class="keyword">local</span> <span class="built_in">path</span> = &#123; <span class="built_in">unpack</span>(context.<span class="built_in">path</span>) &#125;</span><br><span class="line">   <span class="keyword">local</span> name = <span class="built_in">table</span>.<span class="built_in">concat</span>(<span class="built_in">path</span>, <span class="string">"."</span>)</span><br><span class="line">   <span class="keyword">local</span> node = context.treecache[name]</span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> lowest</span><br><span class="line">   <span class="keyword">if</span> node <span class="keyword">and</span> node.nodes <span class="keyword">and</span> <span class="built_in">next</span>(node.nodes) <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">local</span> k, v</span><br><span class="line">      <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(node.nodes) <span class="keyword">do</span></span><br><span class="line">         <span class="keyword">if</span> <span class="keyword">not</span> lowest <span class="keyword">or</span></span><br><span class="line">            (v.order <span class="keyword">or</span> <span class="number">100</span>) &lt; (node.nodes[lowest].order <span class="keyword">or</span> <span class="number">100</span>)</span><br><span class="line">         <span class="keyword">then</span></span><br><span class="line">            lowest = k</span><br><span class="line">         <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">assert</span>(lowest ~= <span class="literal">nil</span>,</span><br><span class="line">          <span class="string">"The requested node contains no childs, unable to redispatch"</span>)</span><br><span class="line"></span><br><span class="line">   <span class="built_in">path</span>[#<span class="built_in">path</span>+<span class="number">1</span>] = lowest</span><br><span class="line">   dispatch(<span class="built_in">path</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">firstchild</span><span class="params">()</span></span></span><br><span class="line">   <span class="keyword">return</span> &#123; <span class="built_in">type</span> = <span class="string">"firstchild"</span>, target = _firstchild &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">alias</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> req = &#123;...&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">for</span> _, r <span class="keyword">in</span> <span class="built_in">ipairs</span>(&#123;...&#125;) <span class="keyword">do</span></span><br><span class="line">            req[#req+<span class="number">1</span>] = r</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        dispatch(req)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rewrite</span><span class="params">(n, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> req = &#123;...&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">local</span> dispatched = util.clone(context.dispatched)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">1</span>,n <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">remove</span>(dispatched, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, r <span class="keyword">in</span> <span class="built_in">ipairs</span>(req) <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(dispatched, i, r)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _, r <span class="keyword">in</span> <span class="built_in">ipairs</span>(&#123;...&#125;) <span class="keyword">do</span></span><br><span class="line">            dispatched[#dispatched+<span class="number">1</span>] = r</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        dispatch(dispatched)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _call<span class="params">(self, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> func = <span class="built_in">getfenv</span>()[self.name]</span><br><span class="line">    <span class="built_in">assert</span>(func ~= <span class="literal">nil</span>,</span><br><span class="line">           <span class="string">'Cannot resolve function "'</span> .. self.name .. <span class="string">'". Is it misspelled or local?'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">type</span>(func) == <span class="string">"function"</span>,</span><br><span class="line">           <span class="string">'The symbol "'</span> .. self.name .. <span class="string">'" does not refer to a function but data '</span> ..</span><br><span class="line">           <span class="string">'of type "'</span> .. <span class="built_in">type</span>(func) .. <span class="string">'".'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> #self.argv &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> func(<span class="built_in">unpack</span>(self.argv), ...)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> func(...)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">(name, ...)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="built_in">type</span> = <span class="string">"call"</span>, argv = &#123;...&#125;, name = name, target = _call&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">post_on</span><span class="params">(params, name, ...)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="built_in">type</span> = <span class="string">"call"</span>,</span><br><span class="line">        post = params,</span><br><span class="line">        argv = &#123; ... &#125;,</span><br><span class="line">        name = name,</span><br><span class="line">        target = _call</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">return</span> post_on(<span class="literal">true</span>, ...)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> _template = <span class="function"><span class="keyword">function</span><span class="params">(self, ...)</span></span></span><br><span class="line">    <span class="built_in">require</span> <span class="string">"luci.template"</span>.render(self.view)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">template</span><span class="params">(name)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="built_in">type</span> = <span class="string">"template"</span>, view = name, target = _template&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _cbi<span class="params">(self, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> cbi = <span class="built_in">require</span> <span class="string">"luci.cbi"</span></span><br><span class="line">    <span class="keyword">local</span> tpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line">    <span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">"luci.http"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = self.<span class="built_in">config</span> <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> maps = cbi.<span class="built_in">load</span>(self.model, ...)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> state = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, res <span class="keyword">in</span> <span class="built_in">ipairs</span>(maps) <span class="keyword">do</span></span><br><span class="line">        res.flow = <span class="built_in">config</span></span><br><span class="line">        <span class="keyword">local</span> cstate = res:parse()</span><br><span class="line">        <span class="keyword">if</span> cstate <span class="keyword">and</span> (<span class="keyword">not</span> state <span class="keyword">or</span> cstate &lt; state) <span class="keyword">then</span></span><br><span class="line">            state = cstate</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _resolve_path<span class="params">(path)</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">type</span>(<span class="built_in">path</span>) == <span class="string">"table"</span> <span class="keyword">and</span> build_url(<span class="built_in">unpack</span>(<span class="built_in">path</span>)) <span class="keyword">or</span> <span class="built_in">path</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span>.on_valid_to <span class="keyword">and</span> state <span class="keyword">and</span> state &gt; <span class="number">0</span> <span class="keyword">and</span> state &lt; <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">        http.redirect(_resolve_path(<span class="built_in">config</span>.on_valid_to))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span>.on_changed_to <span class="keyword">and</span> state <span class="keyword">and</span> state &gt; <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        http.redirect(_resolve_path(<span class="built_in">config</span>.on_changed_to))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span>.on_success_to <span class="keyword">and</span> state <span class="keyword">and</span> state &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        http.redirect(_resolve_path(<span class="built_in">config</span>.on_success_to))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span>.state_handler <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">config</span>.state_handler(state, maps) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    http.header(<span class="string">"X-CBI-State"</span>, state <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">config</span>.noheader <span class="keyword">then</span></span><br><span class="line">        tpl.render(<span class="string">"cbi/header"</span>, &#123;state = state&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> redirect</span><br><span class="line">    <span class="keyword">local</span> messages</span><br><span class="line">    <span class="keyword">local</span> applymap   = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">local</span> pageaction = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">local</span> parsechain = &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, res <span class="keyword">in</span> <span class="built_in">ipairs</span>(maps) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> res.apply_needed <span class="keyword">and</span> res.parsechain <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> c</span><br><span class="line">            <span class="keyword">for</span> _, c <span class="keyword">in</span> <span class="built_in">ipairs</span>(res.parsechain) <span class="keyword">do</span></span><br><span class="line">                parsechain[#parsechain+<span class="number">1</span>] = c</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            applymap = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> res.redirect <span class="keyword">then</span></span><br><span class="line">            redirect = redirect <span class="keyword">or</span> res.redirect</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> res.pageaction == <span class="literal">false</span> <span class="keyword">then</span></span><br><span class="line">            pageaction = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> res.message <span class="keyword">then</span></span><br><span class="line">            messages = messages <span class="keyword">or</span> &#123; &#125;</span><br><span class="line">            messages[#messages+<span class="number">1</span>] = res.message</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, res <span class="keyword">in</span> <span class="built_in">ipairs</span>(maps) <span class="keyword">do</span></span><br><span class="line">        res:render(&#123;</span><br><span class="line">            firstmap   = (i == <span class="number">1</span>),</span><br><span class="line">            applymap   = applymap,</span><br><span class="line">            redirect   = redirect,</span><br><span class="line">            messages   = messages,</span><br><span class="line">            pageaction = pageaction,</span><br><span class="line">            parsechain = parsechain</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">config</span>.nofooter <span class="keyword">then</span></span><br><span class="line">        tpl.render(<span class="string">"cbi/footer"</span>, &#123;</span><br><span class="line">            flow       = <span class="built_in">config</span>,</span><br><span class="line">            pageaction = pageaction,</span><br><span class="line">            redirect   = redirect,</span><br><span class="line">            state      = state,</span><br><span class="line">            autoapply  = <span class="built_in">config</span>.autoapply</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cbi</span><span class="params">(model, config)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="built_in">type</span> = <span class="string">"cbi"</span>,</span><br><span class="line">        post = &#123; [<span class="string">"cbi.submit"</span>] = <span class="string">"1"</span> &#125;,</span><br><span class="line">        <span class="built_in">config</span> = <span class="built_in">config</span>,</span><br><span class="line">        model = model,</span><br><span class="line">        target = _cbi</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _arcombine<span class="params">(self, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> argv = &#123;...&#125;</span><br><span class="line">    <span class="keyword">local</span> target = #argv &gt; <span class="number">0</span> <span class="keyword">and</span> self.targets[<span class="number">2</span>] <span class="keyword">or</span> self.targets[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">setfenv</span>(target.target, self.env)</span><br><span class="line">    target:target(<span class="built_in">unpack</span>(argv))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arcombine</span><span class="params">(trg1, trg2)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="built_in">type</span> = <span class="string">"arcombine"</span>, env = <span class="built_in">getfenv</span>(), target = _arcombine, targets = &#123;trg1, trg2&#125;&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _form<span class="params">(self, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> cbi = <span class="built_in">require</span> <span class="string">"luci.cbi"</span></span><br><span class="line">    <span class="keyword">local</span> tpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line">    <span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">"luci.http"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> maps = luci.cbi.<span class="built_in">load</span>(self.model, ...)</span><br><span class="line">    <span class="keyword">local</span> state = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, res <span class="keyword">in</span> <span class="built_in">ipairs</span>(maps) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> cstate = res:parse()</span><br><span class="line">        <span class="keyword">if</span> cstate <span class="keyword">and</span> (<span class="keyword">not</span> state <span class="keyword">or</span> cstate &lt; state) <span class="keyword">then</span></span><br><span class="line">            state = cstate</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    http.header(<span class="string">"X-CBI-State"</span>, state <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">    tpl.render(<span class="string">"header"</span>)</span><br><span class="line">    <span class="keyword">for</span> i, res <span class="keyword">in</span> <span class="built_in">ipairs</span>(maps) <span class="keyword">do</span></span><br><span class="line">        res:render()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    tpl.render(<span class="string">"footer"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">form</span><span class="params">(model)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="built_in">type</span> = <span class="string">"cbi"</span>,</span><br><span class="line">        post = &#123; [<span class="string">"cbi.submit"</span>] = <span class="string">"1"</span> &#125;,</span><br><span class="line">        model = model,</span><br><span class="line">        target = _form</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">translate = i18n.translate</span><br><span class="line"></span><br><span class="line"><span class="comment">-- This function does not actually translate the given argument but</span></span><br><span class="line"><span class="comment">-- is used by build/i18n-scan.pl to find translatable entries.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> _<span class="params">(text)</span></span></span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>


        <div class="div_qrcode">
            <div id="combine"></div>
        </div>
    </div>

    <div class="post-footer">
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2018/05/24/工具/03Windows清除垃圾脚本/" class="pre-post btn btn-default" title='Windows 清除系统垃圾脚本'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">Windows 清除系统垃圾脚本</span>
        </a>
    
    
        <a href="/2018/05/23/工具/02Linux串口调试工具/" class="next-post btn btn-default" title='Linux 串口调试工具'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">Linux 串口调试工具</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>
<div id="vcomments"></div>





                </main>
                
    <aside class="col-md-4 sidebar">
        
        
  <div class="widget">
    <div >
        <h3>FLIPPED</h3>
<div>
<div style="float:left; clear: both;" align="center">
<img src="/img/about.jpg" style="width: 80%;">
</div>
<p style="align:center;line-height: 25px;font-size: 13.6px;min-height:250px">The higher I got, the more amazed I was by the view.Some of us get dipped in flat, some in satin, some in gloss. But every once in a while you find someone who's iridescent, and when you do, nothing will ever compare.And I realized Garrett was right about one thing: I had flipped. Completely.人性的美具有纷繁的多面性，无论是男女之爱还是亲人之情，所有的美都会令人向往和感动!</p>
</div>
    </div>
  </div>


        
        
    <div class="widget">    
        <h3 class="title">搜索</h3>
        <div id="search-form">
            <div id="result-mask" class="hide"></div>
            <div class="search-area">
                
                    <input id="search-key" type="search" autocomplete="off" placeholder="搜点什么呢?">
                    <button type="button" class="search-form-submit" id="search-local">站内搜索</button>
                
            </div>
            <div id="result-wrap" class="hide">
                <div id="search-result"></div>
            </div>
            <div class="hide">
                <template id="search-tpl">
                    <div class="item">
                        <a href="/{path}" title="{title}">
                            <div class="title">{title}</div>
                            <div class="content">{content}</div>
                        </a>
                    </div>
                </template>
            </div>
        </div>
    </div>

        
        
    <div class="widget">
        <h3 class="title">分类</h3>
        <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/"><i class="fa" aria-hidden="true">Linux</i></a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/"><i class="fa" aria-hidden="true">前端</i></a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/"><i class="fa" aria-hidden="true">工具</i></a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/心记/"><i class="fa" aria-hidden="true">心记</i></a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂读/"><i class="fa" aria-hidden="true">杂读</i></a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/"><i class="fa" aria-hidden="true">笔记</i></a><span class="category-list-count">12</span></li></ul>
    </div>


        
        
    <div class="widget">
      <h3 class="title">归档</h3>
        <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/"><i class="fa" aria-hidden="true">December 2019</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/"><i class="fa" aria-hidden="true">November 2019</i></a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/"><i class="fa" aria-hidden="true">July 2019</i></a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/"><i class="fa" aria-hidden="true">June 2019</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/"><i class="fa" aria-hidden="true">May 2019</i></a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/"><i class="fa" aria-hidden="true">September 2018</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/"><i class="fa" aria-hidden="true">August 2018</i></a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/"><i class="fa" aria-hidden="true">July 2018</i></a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/"><i class="fa" aria-hidden="true">June 2018</i></a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/"><i class="fa" aria-hidden="true">May 2018</i></a><span class="archive-list-count">12</span></li></ul>
    </div>


        
        
  <div class="widget">
    <h3 class="title">标签云</h3>
    <div class="content tag-cloud">
        <a href="/tags/Gerrit/" style="font-size: 15px;">Gerrit</a> <a href="/tags/Luci/" style="font-size: 10px;">Luci</a> <a href="/tags/cpu/" style="font-size: 10px;">cpu</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/linux工具/" style="font-size: 20px;">linux工具</a> <a href="/tags/netfilter/" style="font-size: 10px;">netfilter</a> <a href="/tags/ping/" style="font-size: 10px;">ping</a> <a href="/tags/samba/" style="font-size: 10px;">samba</a> <a href="/tags/shell脚本/" style="font-size: 10px;">shell脚本</a> <a href="/tags/socket/" style="font-size: 15px;">socket</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/tmux/" style="font-size: 10px;">tmux</a> <a href="/tags/win工具/" style="font-size: 10px;">win工具</a> <a href="/tags/win脚本/" style="font-size: 10px;">win脚本</a> <a href="/tags/前端/" style="font-size: 10px;">前端</a> <a href="/tags/套接字/" style="font-size: 10px;">套接字</a> <a href="/tags/技术书/" style="font-size: 10px;">技术书</a> <a href="/tags/文件/" style="font-size: 10px;">文件</a> <a href="/tags/文章/" style="font-size: 10px;">文章</a> <a href="/tags/电影/" style="font-size: 10px;">电影</a> <a href="/tags/算法/" style="font-size: 10px;">算法</a> <a href="/tags/线程/" style="font-size: 10px;">线程</a> <a href="/tags/网站/" style="font-size: 10px;">网站</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/转载/" style="font-size: 15px;">转载</a> <a href="/tags/进程控制/" style="font-size: 10px;">进程控制</a> <a href="/tags/锁/" style="font-size: 10px;">锁</a>
    </div>
  </div>


        
    </aside>

            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12"> 
                <span>Copyright &copy; 2018
                </span> | 
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> | 
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>


<script src="/js/jquery-3.3.1.js?rev=@@hash"></script>

	<script src="/js/search.js?rev=@@hash"></script>


<script src="/js/app.js?rev=@@hash"></script>
<script src="/js/menu.js?rev=@@hash"></script>
<script src="/js/qart.min.js?rev=@@hash"></script>
<script src="/js/clipboard.min.js?rev=@@hash"></script>
<script src="/js/av-min.js?rev=@@hash"></script>
<script src="/js/Valine.min.js?rev=@@hash"></script>
<script src="/js/web_tools.js?rev=@@hash"></script>



</body>
</html>